# Terminal setup
set -ga terminal-overrides ",*256col*:RGB"
set -g default-terminal "tmux-256color"
set -g default-shell "/bin/zsh"
set -g default-command "/bin/zsh -l"
set -s extended-keys on
set -s extended-keys-format csi-u
set -sg escape-time 0

# Input and mouse
set -g mouse on
set-window-option -g mode-keys vi

# Prefix and splits
unbind C-b
set -g prefix C-a
bind-key C-a send-prefix

unbind %
bind '\\' split-window -h -c "#{pane_current_path}"

unbind '"'
bind - split-window -v -c "#{pane_current_path}"

# New windows and reload
bind c new-window -c "#{pane_current_path}"
unbind r
bind r source-file ~/.config/tmux/tmux.conf \; display "~/.config/tmux/tmux.conf sourced"

# Pane resizing
bind -r j resize-pane -D 5
bind -r k resize-pane -U 5
bind -r l resize-pane -R 5
bind -r h resize-pane -L 5
bind -r m resize-pane -Z

# Kill shortcuts
unbind-key x
bind-key x kill-pane
bind-key X kill-session

# Popup windows
# From https://github.com/ianchesal/dotfiles/blob/e2b7f01fcf74dafc683274522c35c5ef5e8e801b/tmux/tmux.conf#L131
# These two shortcuts provide popup windows in tmux. The lowercase version
# makes a popup that named uniquely to the working directory. This is great
# for making a popup window in a coding project.
#
# The uppercase version makes a "global" popup window. Great for persisting
# things globally for a long period of time.
bind g run-shell '\\
    POPUP_NAME="popup-$(basename "#{pane_current_path}" | tr -cd "a-zA-Z0-9-")"; \\
    if [ "#{session_name}" = "$POPUP_NAME" ]; then \\
        tmux detach-client; \\
    else \\
        tmux display-popup -d "#{pane_current_path}" -xC -yC -w 80% -h 75% -E "tmux attach-session -t $POPUP_NAME || tmux new-session -s $POPUP_NAME"; \\
    fi \\
'

bind G run-shell '\\
    POPUP_NAME="popup-global"; \\
    if [ "#{session_name}" = "$POPUP_NAME" ]; then \\
        tmux detach-client; \\
    else \\
        tmux display-popup -xC -yC -w 80% -h 75% -E "tmux attach-session -t $POPUP_NAME || tmux new-session -s $POPUP_NAME"; \\
    fi \\
'

# Pane navigation (vim-tmux-navigator)
# Remove legacy Prefix+hjkl and Ctrl+hjkl bindings from previous config/plugin runs.
unbind-key -n C-h
unbind-key -n C-j
unbind-key -n C-k
unbind-key -n C-l
unbind-key -T copy-mode-vi C-h
unbind-key -T copy-mode-vi C-j
unbind-key -T copy-mode-vi C-k
unbind-key -T copy-mode-vi C-l

# Copy mode (vi + macOS clipboard)
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel "pbcopy"
# bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"

# Session and window navigation
bind S command-prompt -p "New Session:" "new-session -A -s '%%'"
bind C-p previous-window
bind C-n next-window
# bind C-f command-prompt -p find-session "switch-client -t %%"

# Window behavior
setw -g automatic-rename off
set -g renumber-windows on

# Pane and window indexing
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1

# Statusline (GitHub Dark)
set -g mode-style "fg=#c9d1d9,bg=#30363d"
set -g message-style "fg=#c9d1d9,bg=#30363d"
set -g message-command-style "fg=#c9d1d9,bg=#30363d"
set -g pane-border-style "fg=#30363d"
set -g pane-active-border-style "fg=#58a6ff"

set -g status "on"
set -g status-position top
set -g status-interval 1
set -g status-justify "left"
set -g status-style "fg=#58a6ff,bg=#0d1117"
set -g status-left-length "100"
set -g status-right-length "100"
set -g status-left-style NONE
set -g status-right-style NONE

set -g status-left "#[fg=#0d1117,bg=#58a6ff,bold] #S #[fg=#58a6ff,bg=#0d1117,nobold,nounderscore,noitalics]"
set -g status-right "#{?client_prefix,#[reverse]<Prefix>#[noreverse],}#[fg=#30363d,bg=#0d1117,nobold,nounderscore,noitalics]#[fg=#c9d1d9,bg=#30363d] %Y-%m-%d %a î‚² %H:%M #[fg=#58a6ff,bg=#30363d,nobold,nounderscore,noitalics]#[fg=#0d1117,bg=#58a6ff,bold] #U@#H "

setw -g window-status-activity-style "underscore,fg=#8b949e,bg=#0d1117"
setw -g window-status-separator ""
setw -g window-status-style "NONE,fg=#8b949e,bg=#0d1117"
setw -g window-status-format "#[fg=#0d1117,bg=#0d1117,nobold,nounderscore,noitalics]#[fg=#8b949e,bg=#0d1117] #I  #W #F #[fg=#0d1117,bg=#0d1117,nobold,nounderscore,noitalics]"
setw -g window-status-current-format "#[fg=#0d1117,bg=#3fb950,nobold,nounderscore,noitalics]#[fg=#0d1117,bg=#3fb950,bold] #I  #W #F #[fg=#3fb950,bg=#0d1117,nobold,nounderscore,noitalics]"

# Plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'alexwforsythe/tmux-which-key'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'soyuka/tmux-current-pane-hostname'

# Plugin settings
set -g @vim_navigator_mapping_left "M-h"
set -g @vim_navigator_mapping_down "M-j"
set -g @vim_navigator_mapping_up "M-k"
set -g @vim_navigator_mapping_right "M-l"

TMUX_FZF_LAUNCH_KEY="C-f"

set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
